<html>

<head>
  <style>
    .youtube-container iframe {
      border: none;
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div id="youtube-container" class="youtube-container">
  </div>

  <script type="text/javascript">
    // State of the widget
    let currentSettings = {};

    function getAspectRatioPercentage(aspectRatio) {
      const ratios = {
        '1:1': '100%',
        '4:3': '75%',
        '16:9': '56.25%',
        '9:16': '177.78%',
        '21:9': '42.86%',
        '3:1': '33.33%'
      };
      return ratios[aspectRatio];
    }

    function buildIframeUrl() {
      const baseUrl = 'https://www.youtube-nocookie.com/embed';
      const playlistId = currentSettings.playlistId.trim();
      const videoId = currentSettings.videoId.trim();

      const params = new URLSearchParams();

      // If playlist is specified, use playlist mode
      let url;
      if (playlistId) {
        url = `${baseUrl}/videoseries`;
        params.append('list', playlistId);
      } else {
        url = `${baseUrl}/${videoId}`;
      }

      if (currentSettings.autoplay) {
        params.append('autoplay', '1');
        // Autoplay usually requires the video to be muted
        params.append('mute', '1');
      } else if (currentSettings.mute) {
        params.append('mute', '1');
      }

      if (!currentSettings.controls) {
        params.append('controls', '0');
      }
      if (currentSettings.loop) {
        params.append('loop', '1');
      }

      params.append('playsinline', '1');
      if (currentSettings.start > 0) {
        params.append('start', String(currentSettings.start));
      }

      params.append('fs', '1');

      const queryString = params.toString();
      return `${url}${queryString ? '?' + queryString : ''}`;
    }

    function render() {
      const content = document.getElementById('youtube-container');

      const iframeUrl = buildIframeUrl();

      const iframe = document.createElement('iframe');
      iframe.src = iframeUrl;
      iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
      iframe.allowFullscreen = true;

      content.innerHTML = '';
      content.appendChild(iframe);
    }

    let wakeLock = null;

    async function updateWakeLock() {
      try {
        if (currentSettings.preventSleep) {
          if (!wakeLock) {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log('Wake Lock active');
            wakeLock.addEventListener('release', () => {
              console.log('Wake Lock released');
              wakeLock = null;
            });
          }
        } else {
          if (wakeLock) {
            await wakeLock.release();
            wakeLock = null;
          }
        }
      } catch (err) {
        console.error(`${err.name}, ${err.message}`);
      }
    }

    // Re-request wake lock when visibility changes (if it was released by system)
    document.addEventListener('visibilitychange', async () => {
      if (wakeLock !== null && document.visibilityState === 'visible') {
        updateWakeLock();
      }
    });

    async function onHomeyReady(Homey) {
      currentSettings = Homey.getSettings();
      const heightPercentage = getAspectRatioPercentage(currentSettings.aspectRatio);
      render();
      updateWakeLock();

      Homey.ready({ height: heightPercentage });

      Homey.on('settings.set', (key, value) => {
        console.log('YouTube: settings.set', key, value);
        currentSettings[key] = value;
        const newHeightPercentage = getAspectRatioPercentage(currentSettings.aspectRatio);
        render();
        Homey.setHeight(newHeightPercentage);

        if (key === 'preventSleep') {
          updateWakeLock();
        }
      });
    }
  </script>
</body>

</html>