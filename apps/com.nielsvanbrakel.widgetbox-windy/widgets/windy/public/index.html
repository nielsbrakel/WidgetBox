<html>

<head>
  <style>
    .windy-container {
      width: 100%;
      height: 100%;
      touch-action: none;
      position: relative;
    }

    .windy-container iframe {
      border: none;
      width: 100%;
      height: 100%;
      pointer-events: auto;
      /* Ensure iframe receives events */
    }

    #windy-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10;
      /* High z-index to sit on top of iframe */
      background: transparent;
      /* Invisible but interactive */
    }
  </style>
</head>

<body>
  <div id="windy-container" class="windy-container">
    <div id="windy-overlay"></div>
  </div>

  <script type="text/javascript">
    // State of the widget
    let currentSettings = {};

    function getAspectRatioPercentage(aspectRatio) {
      const ratios = {
        '1:1': '100%',
        '4:3': '75%',
        '16:9': '56.25%',
        '21:9': '42.86%',
        '3:1': '33.33%'
      };
      return ratios[aspectRatio];
    }

    function buildIframeUrl() {
      const baseUrl = 'https://embed.windy.com/embed.html';

      const params = new URLSearchParams();
      params.append('type', 'map');
      params.append('location', 'coordinates');

      // Metrics settings
      const windMetricMap = {
        'default': 'default',
        'kmh': 'km/h',
        'mph': 'mph',
        'ms': 'm/s',
        'knots': 'kt'
      };

      params.append('metricRain', currentSettings.metricRain);
      params.append('metricTemp', currentSettings.metricTemp);
      params.append('metricWind', windMetricMap[currentSettings.metricWind] || currentSettings.metricWind);

      // Location settings
      params.append('lat', currentSettings.latitude);
      params.append('lon', currentSettings.longitude);

      // Detail location
      params.append('detailLat', currentSettings.detailLatitude || currentSettings.latitude);
      params.append('detailLon', currentSettings.detailLongitude || currentSettings.longitude);

      // Detail view
      params.append('detail', currentSettings.openDetailsByDefault ? 'true' : 'false');

      // Map settings
      params.append('zoom', currentSettings.zoom);
      params.append('overlay', currentSettings.overlay);
      params.append('product', currentSettings.product);
      params.append('level', currentSettings.level);

      // Visibility settings
      params.append('pressure', currentSettings.pressure ? 'true' : 'false');
      params.append('marker', currentSettings.marker ? 'true' : 'false');
      params.append('message', currentSettings.message ? 'true' : 'false');

      // Build query string
      const queryString = params.toString();
      return `${baseUrl}?${queryString}`;
    }

    function render() {
      const content = document.getElementById('windy-container');

      const iframeUrl = buildIframeUrl();

      const iframe = document.createElement('iframe');
      iframe.src = iframeUrl;
      iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
      iframe.setAttribute('frameborder', '0');

      // Stop touch event propagation to prevent dashboard scrolling while interacting with map
      content.addEventListener('touchstart', (e) => e.stopPropagation(), { passive: true });
      content.addEventListener('touchmove', (e) => e.stopPropagation(), { passive: true });
      content.addEventListener('touchend', (e) => e.stopPropagation(), { passive: true });

      content.innerHTML = '';
      content.appendChild(iframe);

      // Re-create overlay since we cleared innerHTML
      const overlay = document.createElement('div');
      overlay.id = 'windy-overlay';
      overlay.onclick = function () {
        this.style.pointerEvents = 'none';
        // Optional: show a visual indicator that map is active? 
        // For now just enable interaction.

        // Re-enable overlay after timeout
        setTimeout(() => {
          overlay.style.pointerEvents = 'auto';
        }, 10000); // 10 seconds timeout
      };

      content.appendChild(overlay);
    }

    async function onHomeyReady(Homey) {
      currentSettings = Homey.getSettings();
      const heightPercentage = getAspectRatioPercentage(currentSettings.aspectRatio || '16:9');
      render();

      Homey.ready({ height: heightPercentage });

      Homey.on('settings.set', (key, value) => {
        currentSettings[key] = value;
        const newHeightPercentage = getAspectRatioPercentage(currentSettings.aspectRatio || '16:9');
        render();
        Homey.setHeight(newHeightPercentage);
      });
    }
  </script>
</body>

</html>